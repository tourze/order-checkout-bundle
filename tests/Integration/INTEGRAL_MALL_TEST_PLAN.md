# ç§¯åˆ†å•†åŸè´­ä¹°åœºæ™¯æµ‹è¯•è®¡åˆ’

## ğŸ“‹ æµ‹è¯•ç›®æ ‡

éªŒè¯ç§¯åˆ†å•†åŸå•†å“è´­ä¹°çš„å®Œæ•´æµç¨‹,ç¡®ä¿:
1. ç§¯åˆ†è®¡ç®—å‡†ç¡®æ— è¯¯
2. è®¢å•åˆ›å»ºæ­£ç¡®å¤„ç†ç§¯åˆ†æ‰£å‡
3. å¼‚å¸¸åœºæ™¯å¦¥å–„å¤„ç†
4. ç§¯åˆ†é€€è¿˜æœºåˆ¶å¯é ä¸”å¹‚ç­‰

## ğŸ¯ æµ‹è¯•èŒƒå›´

### 1. ä»·æ ¼è®¡ç®—å±‚ (BasePriceCalculator)

#### âœ… æµ‹è¯•ç”¨ä¾‹ 1.1: çº¯ç§¯åˆ†å•†å“ä»·æ ¼è®¡ç®—
- **è¾“å…¥**: SKU(integral=100, price=0), quantity=2
- **é¢„æœŸè¾“å‡º**:
  - `finalPrice` = "0.00"
  - `total_integral_required` = 200
  - `base_price[0].integral_required` = 100
  - `base_price[0].total_integral` = 200

#### âœ… æµ‹è¯•ç”¨ä¾‹ 1.2: æ··åˆå•†å“ä»·æ ¼è®¡ç®—
- **è¾“å…¥**: SKU(integral=50, price=99.00), quantity=1
- **é¢„æœŸè¾“å‡º**:
  - `finalPrice` = "99.00"
  - `total_integral_required` = 50

#### âœ… æµ‹è¯•ç”¨ä¾‹ 1.3: å¤šå•†å“æ··åˆåœºæ™¯
ä½¿ç”¨æ•°æ®æä¾›è€…æµ‹è¯•å¤šç§ç»„åˆ:
- ä¸¤ä¸ªçº¯ç§¯åˆ†å•†å“
- çº¯ç§¯åˆ† + æ··åˆå•†å“
- ä¸‰ä¸ªæ··åˆå•†å“

éªŒè¯ç°é‡‘å’Œç§¯åˆ†çš„æ­£ç¡®ç´¯åŠ ã€‚

---

### 2. è®¢å•åˆ›å»ºå±‚ (CheckoutService)

#### âœ… æµ‹è¯•ç”¨ä¾‹ 2.1: çº¯ç§¯åˆ†è®¢å•è‡ªåŠ¨æ ‡è®°ä¸º PAID
- **å‰ç½®æ¡ä»¶**: ç§¯åˆ†æ‰£å‡æˆåŠŸ
- **è¾“å…¥**: finalPrice=0, integralRequired=100
- **é¢„æœŸ**:
  - è®¢å•çŠ¶æ€ = `OrderState::PAID`
  - ç§¯åˆ†æ‰£å‡æ“ä½œIDå·²è®°å½•

#### âœ… æµ‹è¯•ç”¨ä¾‹ 2.2: æ··åˆè®¢å•ä¿æŒ INIT çŠ¶æ€
- **å‰ç½®æ¡ä»¶**: ç§¯åˆ†æ‰£å‡æˆåŠŸ
- **è¾“å…¥**: finalPrice=99.00, integralRequired=50
- **é¢„æœŸ**:
  - è®¢å•çŠ¶æ€ = `OrderState::INIT`
  - ç­‰å¾…ç°é‡‘æ”¯ä»˜

---

### 3. å¼‚å¸¸å¤„ç†å±‚

#### âœ… æµ‹è¯•ç”¨ä¾‹ 3.1: ç§¯åˆ†ä½™é¢ä¸è¶³
- **æ¨¡æ‹Ÿ**: IntegralService æŠ›å‡º `InsufficientBalanceException`
- **é¢„æœŸ**:
  - CheckoutService æ•è·å¹¶è½¬æ¢ä¸º `CheckoutException`
  - å¼‚å¸¸æ¶ˆæ¯åŒ…å« "ç§¯åˆ†ä½™é¢ä¸è¶³"
  - è®¢å•ä¸ä¼šè¢«åˆ›å»º

#### âœ… æµ‹è¯•ç”¨ä¾‹ 3.2: ç§¯åˆ†æœåŠ¡ä¸å¯ç”¨
- **æ¨¡æ‹Ÿ**: IntegralService æŠ›å‡º `ServiceUnavailableException`
- **é¢„æœŸ**:
  - CheckoutService æ•è·å¹¶è½¬æ¢ä¸º `CheckoutException`
  - å¼‚å¸¸æ¶ˆæ¯åŒ…å« "ç§¯åˆ†æœåŠ¡æš‚æ—¶ä¸å¯ç”¨"
  - è®¢å•ä¸ä¼šè¢«åˆ›å»º

#### âš ï¸ æµ‹è¯•ç”¨ä¾‹ 3.3: è®¢å•åˆ›å»ºå¤±è´¥è‡ªåŠ¨å›æ»š (å¾…å®ç°)
- **æ¨¡æ‹Ÿ**: è®¢å•æŒä¹…åŒ–å¤±è´¥ (EntityManager æŠ›å‡ºå¼‚å¸¸)
- **å‰ç½®**: ç§¯åˆ†å·²æ‰£å‡
- **é¢„æœŸ**:
  - åœ¨ `finally` å—ä¸­è°ƒç”¨ `refundIntegral()`
  - ç§¯åˆ†è‡ªåŠ¨é€€è¿˜ç»™ç”¨æˆ·
  - è®°å½•é”™è¯¯æ—¥å¿—

---

### 4. ç§¯åˆ†é€€è¿˜å±‚ (IntegralRefundService)

#### âœ… æµ‹è¯•ç”¨ä¾‹ 4.1: è®¢å•å–æ¶ˆé€€è¿˜ç§¯åˆ†
- **è¾“å…¥**: å·²æ‰£å‡100ç§¯åˆ†çš„è®¢å•
- **é¢„æœŸ**:
  - è°ƒç”¨ `IntegralService.increaseIntegral()`
  - `OrderIntegralInfo.isRefunded` = true
  - `refundOperationId` å·²è®°å½•
  - `refundedTime` å·²è®°å½•

#### âœ… æµ‹è¯•ç”¨ä¾‹ 4.2: ç§¯åˆ†é€€è¿˜å¹‚ç­‰æ€§
- **è¾“å…¥**: å·²é€€è¿˜çš„è®¢å• (`isRefunded=true`)
- **é¢„æœŸ**:
  - `IntegralService.increaseIntegral()` **ä¸ä¼šè¢«è°ƒç”¨**
  - çŠ¶æ€ä¿æŒä¸å˜

#### âš ï¸ æµ‹è¯•ç”¨ä¾‹ 4.3: é€€è¿˜å¤±è´¥é”™è¯¯å¤„ç† (å¾…å®ç°)
- **æ¨¡æ‹Ÿ**: IntegralService æŠ›å‡ºå¼‚å¸¸
- **é¢„æœŸ**:
  - è®°å½•é”™è¯¯æ—¥å¿—
  - ä¸æŠ›å‡ºå¼‚å¸¸ (ç»§ç»­å¤„ç†å…¶ä»–è®°å½•)
  - çŠ¶æ€ä¿æŒ `isRefunded=false`

---

## ğŸ”§ æµ‹è¯•åŸºç¡€è®¾æ–½

### Mock å¯¹è±¡
- `IntegralServiceInterface`: æ¨¡æ‹Ÿç§¯åˆ†æœåŠ¡
- `SkuLoaderInterface`: æ¨¡æ‹Ÿ SKU åŠ è½½å™¨
- `EntityManagerInterface`: æ¨¡æ‹Ÿæ•°æ®åº“æ“ä½œ
- å…¶ä»–ä¾èµ–æœåŠ¡

### æµ‹è¯•æ•°æ®å·¥å‚
- `createIntegralSku()`: åˆ›å»ºç§¯åˆ†å•†å“ SKU
- `createDeliveryAddress()`: åˆ›å»ºæ”¶è´§åœ°å€

---

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

- **è¡Œè¦†ç›–ç‡**: â‰¥ 90%
- **åˆ†æ”¯è¦†ç›–ç‡**: â‰¥ 85%
- **å…³é”®è·¯å¾„è¦†ç›–**: 100%

### å…³é”®è·¯å¾„æ¸…å•
- [x] çº¯ç§¯åˆ†å•†å“ä»·æ ¼è®¡ç®—
- [x] æ··åˆå•†å“ä»·æ ¼è®¡ç®—
- [x] ç§¯åˆ†ä¸è¶³å¼‚å¸¸
- [x] ç§¯åˆ†æœåŠ¡ä¸å¯ç”¨å¼‚å¸¸
- [ ] è®¢å•åˆ›å»ºå¤±è´¥å›æ»š (å¾…è¡¥å……å®ç°)
- [x] è®¢å•å–æ¶ˆé€€è¿˜ç§¯åˆ†
- [x] é€€è¿˜å¹‚ç­‰æ€§éªŒè¯

---

## âš¡ è¿è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰ç§¯åˆ†ç›¸å…³æµ‹è¯•
```bash
vendor/bin/phpunit packages/order-checkout-bundle/tests/Integration/IntegralMallCheckoutTest.php
```

### è¿è¡Œå•ä¸ªæµ‹è¯•æ–¹æ³•
```bash
vendor/bin/phpunit --filter testPureIntegralProductPriceCalculation packages/order-checkout-bundle/tests/Integration/IntegralMallCheckoutTest.php
```

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
```bash
XDEBUG_MODE=coverage vendor/bin/phpunit --coverage-html coverage packages/order-checkout-bundle/tests/Integration/IntegralMallCheckoutTest.php
```

---

## ğŸ› å·²çŸ¥é—®é¢˜ä¸å¾…åŠ

### å¾…å®ç°çš„æµ‹è¯•
1. **è®¢å•åˆ›å»ºå¤±è´¥å›æ»šæµ‹è¯•**: éœ€è¦æ¨¡æ‹Ÿ EntityManager æŠ›å‡ºå¼‚å¸¸
2. **é€€è¿˜å¤±è´¥é”™è¯¯å¤„ç†æµ‹è¯•**: éªŒè¯æ—¥å¿—è®°å½•å’Œå¼‚å¸¸åå¹¶
3. **çº¯ç§¯åˆ†è®¢å•çŠ¶æ€è‡ªåŠ¨å˜æ›´æµ‹è¯•**: éœ€è¦é›†æˆ CheckoutService çš„å®Œæ•´æµç¨‹

### å¾…ä¿®å¤çš„å®ç°
1. **CheckoutService ç¼ºå°‘ç§¯åˆ†æ‰£å‡é€»è¾‘**:
   - éœ€è¦åœ¨ `process()` æ–¹æ³•ä¸­æ³¨å…¥ `IntegralServiceInterface`
   - å®ç° `deductIntegral()` ç§æœ‰æ–¹æ³•
   - å®ç° `refundIntegral()` ç§æœ‰æ–¹æ³•
   - å®ç° `isPureIntegralOrder()` åˆ¤æ–­é€»è¾‘

2. **BasePriceCalculator ç¼ºå°‘ç§¯åˆ†è®¡ç®—**:
   - éœ€è¦è¯»å– `SKU::getIntegralPrice()`
   - ç´¯åŠ  `total_integral_required`
   - åœ¨å•†å“è¯¦æƒ…ä¸­æ·»åŠ ç§¯åˆ†ä¿¡æ¯

---

## ğŸ“ æµ‹è¯•æ‰§è¡ŒæŠ¥å‘Š

| æµ‹è¯•ç”¨ä¾‹ | çŠ¶æ€ | è¦†ç›–ç‡ | å¤‡æ³¨ |
|---------|------|--------|------|
| çº¯ç§¯åˆ†å•†å“ä»·æ ¼è®¡ç®— | â³ å¾…éªŒè¯ | - | éœ€è¦å®ç° SKU::getIntegralPrice() |
| æ··åˆå•†å“ä»·æ ¼è®¡ç®— | â³ å¾…éªŒè¯ | - | åŒä¸Š |
| å¤šå•†å“æ··åˆåœºæ™¯ | â³ å¾…éªŒè¯ | - | åŒä¸Š |
| ç§¯åˆ†ä¸è¶³å¼‚å¸¸ | â³ å¾…éªŒè¯ | - | éœ€è¦å®ç°ç§¯åˆ†æ‰£å‡é€»è¾‘ |
| ç§¯åˆ†æœåŠ¡ä¸å¯ç”¨ | â³ å¾…éªŒè¯ | - | åŒä¸Š |
| è®¢å•å–æ¶ˆé€€è¿˜ç§¯åˆ† | â³ å¾…éªŒè¯ | - | IntegralRefundService å·²å­˜åœ¨ |
| é€€è¿˜å¹‚ç­‰æ€§ | â³ å¾…éªŒè¯ | - | åŒä¸Š |

**æ›´æ–°æ—¶é—´**: 2025-11-20
**æµ‹è¯•è´Ÿè´£äºº**: Claude
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
