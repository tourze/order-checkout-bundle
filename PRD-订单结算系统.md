# PRD - è®¢å•ç»“ç®—ç³»ç»Ÿï¼ˆOrder Checkout Bundleï¼‰

## ğŸ“‹ äº§å“æ¦‚è¿°

### äº§å“å®šä¹‰
è®¢å•ç»“ç®—ç³»ç»Ÿæ˜¯ç”µå•†å¹³å°çš„æ ¸å¿ƒäº¤æ˜“æ¨¡å—ï¼Œè´Ÿè´£å¤„ç†è´­ç‰©è½¦ç®¡ç†ã€ä»·æ ¼è®¡ç®—ã€ä¿ƒé”€ä¼˜æƒ ã€è¿è´¹è®¡ç®—ã€ä¼˜æƒ åˆ¸åº”ç”¨ç­‰å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œä¸ºç”¨æˆ·æä¾›å®Œæ•´çš„ä¸‹å•ç»“ç®—ä½“éªŒã€‚

### æ ¸å¿ƒä»·å€¼
- **ä¸šåŠ¡ä»·å€¼**ï¼šæå‡ç”µå•†å¹³å°çš„è½¬åŒ–ç‡å’Œç”¨æˆ·ä½“éªŒï¼Œæ”¯æ’‘å®Œæ•´çš„äº¤æ˜“é—­ç¯
- **æŠ€æœ¯ä»·å€¼**ï¼šæä¾›é«˜åº¦è§£è€¦ã€å¯æ‰©å±•çš„ä»·æ ¼è®¡ç®—å¼•æ“å’Œç»“ç®—æœåŠ¡
- **ç”¨æˆ·ä»·å€¼**ï¼šå®æ—¶å‡†ç¡®çš„ä»·æ ¼è®¡ç®—ã€é€æ˜çš„ä¼˜æƒ å±•ç¤ºã€æµç•…çš„ç»“ç®—ä½“éªŒ

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. é«˜åº¦è§£è€¦è®¾è®¡
- ä»·æ ¼è®¡ç®—ä¸ä¿ƒé”€æ´»åŠ¨è§£è€¦
- è´­ç‰©è½¦å­˜å‚¨ä¸å•†å“ä¿¡æ¯è§£è€¦  
- è¿è´¹è®¡ç®—ä¸è®¢å•é€»è¾‘è§£è€¦
- ä¼˜æƒ åˆ¸ç³»ç»Ÿä¸è®¢å•ç³»ç»Ÿè§£è€¦

### 2. å®æ—¶è®¡ç®—ç­–ç•¥
- è´­ç‰©è½¦ä»…å­˜å‚¨å¿…è¦çš„å•†å“æ ‡è¯†ä¿¡æ¯
- æ‰€æœ‰å±•ç¤ºæ•°æ®ï¼ˆä»·æ ¼ã€åº“å­˜ã€ä¿ƒé”€ï¼‰å®æ—¶è·å–
- ç¡®ä¿ç”¨æˆ·çœ‹åˆ°çš„ä¿¡æ¯å§‹ç»ˆå‡†ç¡®

### 3. æ¥å£åŒ–è®¾è®¡
- æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½é€šè¿‡æ¥å£æš´éœ²
- æ”¯æŒå¤šç§ä¿ƒé”€ç­–ç•¥çš„æ’æ‹”å¼æ‰©å±•
- æ”¯æŒå¤šç§ä»·æ ¼è®¡ç®—å™¨çš„ç»„åˆä½¿ç”¨

## ğŸ“Š åŠŸèƒ½è§„åˆ’

### 1. è´­ç‰©è½¦ç®¡ç†æ¨¡å—

#### 1.1 è´­ç‰©è½¦å­˜å‚¨
**å­˜å‚¨å†…å®¹**ï¼š
- ç”¨æˆ· IDï¼ˆå¿…éœ€ï¼‰
- å•†å“ SKU IDï¼ˆå¿…éœ€ï¼‰
- å•†å“æ•°é‡ï¼ˆå¿…éœ€ï¼‰
- åŠ å…¥æ—¶é—´ï¼ˆç”¨äºè¿‡æœŸæ¸…ç†ï¼‰
- è§„æ ¼ä¿¡æ¯ï¼ˆé¢œè‰²ã€å°ºå¯¸ç­‰ï¼‰
- å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

**ä¸å­˜å‚¨å†…å®¹**ï¼š
- å•†å“åç§°ã€å›¾ç‰‡ã€è¯¦æƒ…ï¼ˆå®æ—¶è·å–ï¼‰
- å•†å“ä»·æ ¼ï¼ˆå®æ—¶è®¡ç®—ï¼‰
- ä¿ƒé”€ä¿¡æ¯ï¼ˆå®æ—¶åŒ¹é…ï¼‰
- åº“å­˜çŠ¶æ€ï¼ˆå®æ—¶æŸ¥è¯¢ï¼‰

#### 1.2 è´­ç‰©è½¦æ“ä½œ
- æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
- æ›´æ–°å•†å“æ•°é‡
- åˆ é™¤è´­ç‰©è½¦å•†å“
- æ¸…ç©ºè´­ç‰©è½¦
- è´­ç‰©è½¦å•†å“åˆå¹¶ï¼ˆç™»å½•åï¼‰

### 2. ä»·æ ¼è®¡ç®—å¼•æ“

#### 2.1 å¤šå±‚ä»·æ ¼è®¡ç®—æ¶æ„
```
åŸºç¡€ä»·æ ¼ â†’ å•†å“çº§ä¿ƒé”€ â†’ è®¢å•çº§ä¿ƒé”€ â†’ ä¼˜æƒ åˆ¸ â†’ æœ€ç»ˆä»·æ ¼
```

#### 2.2 ä»·æ ¼è®¡ç®—å™¨æ¥å£
```php
interface PriceCalculatorInterface
{
    public function calculate(CalculationContext $context): PriceResult;
    public function supports(CalculationContext $context): bool;
    public function getPriority(): int;
}
```

#### 2.3 æ ¸å¿ƒä»·æ ¼è®¡ç®—å™¨
- **åŸºç¡€ä»·æ ¼è®¡ç®—å™¨**ï¼šè·å–å•†å“åŸºç¡€å”®ä»·
- **å•†å“ä¿ƒé”€è®¡ç®—å™¨**ï¼šç§’æ€ã€å›¢è´­ã€é™æ—¶æŠ˜æ‰£ç­‰
- **è®¢å•ä¿ƒé”€è®¡ç®—å™¨**ï¼šæ»¡å‡ã€æ»¡æŠ˜ã€é˜¶æ¢¯ä¼˜æƒ ç­‰
- **ä¼˜æƒ åˆ¸è®¡ç®—å™¨**ï¼šç°é‡‘åˆ¸ã€æŠ˜æ‰£åˆ¸ã€æ»¡å‡åˆ¸ç­‰
- **è¿è´¹è®¡ç®—å™¨**ï¼šåŸºäºåœ°åŒºã€é‡é‡ã€ä½“ç§¯çš„è¿è´¹è®¡ç®—

### 3. ä¿ƒé”€ç³»ç»Ÿæ¥å£

#### 3.1 ä¿ƒé”€åŒ¹é…æ¥å£
```php
interface PromotionMatcherInterface
{
    public function match(array $items, PromotionContext $context): PromotionResult;
    public function getType(): string;
}
```

#### 3.2 ä¿ƒé”€ç±»å‹æ”¯æŒ
- **å•†å“çº§ä¿ƒé”€**
  - é™æ—¶ç‰¹ä»·
  - ç§’æ€æ´»åŠ¨
  - å›¢è´­ä¼˜æƒ 
  - ä¼šå‘˜ä¸“äº«ä»·

- **è®¢å•çº§ä¿ƒé”€**
  - æ»¡ X å…ƒå‡ Y å…ƒ
  - æ»¡ X ä»¶æ‰“ Y æŠ˜
  - é˜¶æ¢¯å¼æ»¡å‡
  - ä¹° X é€ Y

- **ç»„åˆä¿ƒé”€**
  - å¥—é¤ä¼˜æƒ 
  - è·¨å“ç±»æ»¡å‡
  - åº—é“ºçº§ä¿ƒé”€

### 4. åº“å­˜éªŒè¯æ¨¡å—

#### 4.1 åº“å­˜æ£€æŸ¥æ¥å£
```php
interface StockValidatorInterface
{
    public function validate(array $items): StockValidationResult;
    public function getAvailableQuantity(string $skuId): int;
}
```

#### 4.2 ç‰¹æ®Šåº“å­˜é€»è¾‘
- **èµ å“åº“å­˜éªŒè¯**
  - ä¹°èµ ï¼šä¸»å“ä¸èµ å“å¿…é¡»åŒä»“æœ‰è´§
  - æ»¡èµ ï¼šèµ å“æ— è´§æ—¶å¯æ­£å¸¸ä¸‹å•ï¼Œæç¤º"å…ˆåˆ°å…ˆå¾—"
- **é¢„å”®å•†å“éªŒè¯**
- **é™è´­æ•°é‡éªŒè¯**

### 5. è¿è´¹è®¡ç®—æ¨¡å—

#### 5.1 è¿è´¹è®¡ç®—æ¥å£
```php
interface ShippingCalculatorInterface
{
    public function calculate(ShippingContext $context): ShippingResult;
    public function supports(array $items, string $region): bool;
}
```

#### 5.2 è¿è´¹æ¨¡æ¿æ”¯æŒ
- **å•å“è¿è´¹æ¨¡æ¿**ï¼šç‰¹å®šå•†å“åˆ°ç‰¹å®šåœ°åŒºçš„è¿è´¹è§„åˆ™
- **è®¢å•è¿è´¹æ¨¡æ¿**ï¼šåŸºäºè®¢å•é‡‘é¢/é‡é‡çš„è¿è´¹è§„åˆ™
- **åŒ…é‚®è§„åˆ™**ï¼šæ»¡é¢åŒ…é‚®ã€æŒ‡å®šåœ°åŒºåŒ…é‚®ç­‰

### 6. ä¼˜æƒ åˆ¸ç³»ç»Ÿæ¥å£

#### 6.1 ä¼˜æƒ åˆ¸éªŒè¯æ¥å£
```php
interface CouponValidatorInterface
{
    public function validate(string $couponCode, CouponContext $context): CouponValidationResult;
    public function getAvailableCoupons(string $userId, array $items): array;
}
```

#### 6.2 ä¼˜æƒ åˆ¸ç±»å‹
- **ç°é‡‘åˆ¸**ï¼šæ»¡ X å‡ Y
- **æŠ˜æ‰£åˆ¸**ï¼šX æŠ˜ä¼˜æƒ 
- **å…é‚®åˆ¸**ï¼šå…è¿è´¹
- **æ–°äººåˆ¸**ï¼šé¦–æ¬¡è´­ä¹°ä¸“äº«

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### 1. æ ¸å¿ƒå®ä½“è®¾è®¡

#### 1.1 è´­ç‰©è½¦å®ä½“ (Cart)
```php
class Cart
{
    private string $id;
    private string $userId;
    private array $items;
    private \DateTimeInterface $createdAt;
    private \DateTimeInterface $updatedAt;
}
```

#### 1.2 è´­ç‰©è½¦é¡¹å®ä½“ (CartItem)
```php
class CartItem
{
    private string $id;
    private string $cartId;
    private string $skuId;
    private int $quantity;
    private array $attributes; // è§„æ ¼ä¿¡æ¯
    private ?string $remark;
    private \DateTimeInterface $addedAt;
}
```

#### 1.3 è®¡ç®—ä¸Šä¸‹æ–‡ (CalculationContext)
```php
class CalculationContext
{
    private string $userId;
    private array $items;
    private string $region;
    private array $appliedCoupons;
    private \DateTimeInterface $calculateTime;
}
```

### 2. æœåŠ¡å±‚è®¾è®¡

#### 2.1 è´­ç‰©è½¦æœåŠ¡ (CartService)
- è´­ç‰©è½¦ CRUD æ“ä½œ
- è´­ç‰©è½¦æ•°æ®éªŒè¯
- è´­ç‰©è½¦åˆå¹¶é€»è¾‘

#### 2.2 ç»“ç®—æœåŠ¡ (CheckoutService)
- ç»Ÿç­¹æ•´ä¸ªç»“ç®—æµç¨‹
- åè°ƒå„ä¸ªè®¡ç®—å™¨æ‰§è¡Œ
- ç”Ÿæˆæœ€ç»ˆç»“ç®—ç»“æœ

#### 2.3 ä»·æ ¼è®¡ç®—æœåŠ¡ (PriceCalculationService)
- ç®¡ç†ä»·æ ¼è®¡ç®—å™¨é“¾
- æ‰§è¡Œå¤šå±‚ä»·æ ¼è®¡ç®—
- ç”Ÿæˆä»·æ ¼æ˜ç»†

### 3. æ•°æ®åº“è®¾è®¡

#### 3.1 è´­ç‰©è½¦è¡¨ (carts)
```sql
CREATE TABLE carts (
    id VARCHAR(20) PRIMARY KEY,
    user_id VARCHAR(20) NOT NULL,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    INDEX idx_user_id (user_id)
);
```

#### 3.2 è´­ç‰©è½¦é¡¹è¡¨ (cart_items)
```sql
CREATE TABLE cart_items (
    id VARCHAR(20) PRIMARY KEY,
    cart_id VARCHAR(20) NOT NULL,
    sku_id VARCHAR(20) NOT NULL,
    quantity INT NOT NULL,
    attributes JSON,
    remark TEXT,
    added_at TIMESTAMP NOT NULL,
    INDEX idx_cart_id (cart_id),
    INDEX idx_sku_id (sku_id)
);
```

## ğŸ”§ æ¥å£è®¾è®¡

### 1. è´­ç‰©è½¦ç®¡ç†æ¥å£

#### 1.1 æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
```php
POST /api/cart/items
{
    "sku_id": "sku_123",
    "quantity": 2,
    "attributes": {"color": "çº¢è‰²", "size": "L"},
    "remark": "å¤‡æ³¨ä¿¡æ¯"
}
```

#### 1.2 è·å–è´­ç‰©è½¦ä¿¡æ¯
```php
GET /api/cart
Response: {
    "cart_id": "cart_123",
    "items": [...],
    "summary": {
        "total_items": 5,
        "subtotal": 299.00,
        "discount": 50.00,
        "shipping": 10.00,
        "total": 259.00
    },
    "promotions": [...],
    "available_coupons": [...]
}
```

### 2. ä»·æ ¼è®¡ç®—æ¥å£

#### 2.1 å®æ—¶ä»·æ ¼è®¡ç®—
```php
POST /api/checkout/calculate
{
    "items": [
        {"sku_id": "sku_123", "quantity": 2},
        {"sku_id": "sku_456", "quantity": 1}
    ],
    "region": "beijing",
    "coupons": ["coupon_789"]
}
```

#### 2.2 ä¿ƒé”€åŒ¹é…
```php
POST /api/promotions/match
{
    "items": [...],
    "user_id": "user_123"
}
```

## ğŸ“ˆ æ€§èƒ½è¦æ±‚

### 1. å“åº”æ—¶é—´
- è´­ç‰©è½¦æŸ¥è¯¢ï¼š< 200ms
- ä»·æ ¼è®¡ç®—ï¼š< 500ms
- ä¿ƒé”€åŒ¹é…ï¼š< 300ms

### 2. å¹¶å‘æ”¯æŒ
- æ”¯æŒå•ç”¨æˆ·é«˜é¢‘æ“ä½œï¼ˆç§’æ€åœºæ™¯ï¼‰
- æ”¯æŒå¤šç”¨æˆ·å¹¶å‘è®¿é—®
- è´­ç‰©è½¦æ“ä½œæ”¯æŒä¹è§‚é”

### 3. ç¼“å­˜ç­–ç•¥
- å•†å“åŸºç¡€ä¿¡æ¯ç¼“å­˜ï¼ˆ1å°æ—¶ï¼‰
- ä¿ƒé”€è§„åˆ™ç¼“å­˜ï¼ˆ10åˆ†é’Ÿï¼‰
- ç”¨æˆ·è´­ç‰©è½¦ç¼“å­˜ï¼ˆ30åˆ†é’Ÿï¼‰

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. æ•°æ®å®‰å…¨
- è´­ç‰©è½¦æ•°æ®åŠ å¯†å­˜å‚¨
- ä»·æ ¼è®¡ç®—æœåŠ¡ç«¯éªŒè¯
- é˜²æ­¢ä»·æ ¼ç¯¡æ”¹æ”»å‡»

### 2. ä¸šåŠ¡å®‰å…¨
- åº“å­˜è¶…å–é˜²æŠ¤
- ä¿ƒé”€è§„åˆ™é˜²åˆ·
- ä¼˜æƒ åˆ¸é˜²è–…ç¾Šæ¯›

## ğŸš€ æ‰©å±•æ€§è®¾è®¡

### 1. æ’ä»¶åŒ–ä¿ƒé”€è§„åˆ™
- é€šè¿‡æ¥å£å®ç°æ–°çš„ä¿ƒé”€ç±»å‹
- æ”¯æŒä¿ƒé”€è§„åˆ™çƒ­æ’æ‹”
- ä¿ƒé”€ä¼˜å…ˆçº§å¯é…ç½®

### 2. å¤šæ¸ é“æ”¯æŒ
- æ”¯æŒ B2Cã€B2B ä¸åŒè®¡ä»·é€»è¾‘
- æ”¯æŒå¤šè´§å¸ã€å¤šè¯­è¨€
- æ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»

### 3. ç¬¬ä¸‰æ–¹é›†æˆ
- æ”¯æŒå¤–éƒ¨ä¿ƒé”€ç³»ç»Ÿå¯¹æ¥
- æ”¯æŒç¬¬ä¸‰æ–¹æ”¯ä»˜è®¡ç®—
- æ”¯æŒå¤–éƒ¨åº“å­˜ç³»ç»Ÿ

## ğŸ“‹ å¼€å‘è®¡åˆ’

### Phase 1ï¼šåŸºç¡€åŠŸèƒ½ï¼ˆ2å‘¨ï¼‰
- [ ] è´­ç‰©è½¦åŸºç¡€ CRUD
- [ ] åŸºç¡€ä»·æ ¼è®¡ç®—å¼•æ“
- [ ] ç®€å•ä¿ƒé”€åŒ¹é…
- [ ] åŸºç¡€è¿è´¹è®¡ç®—

### Phase 2ï¼šé«˜çº§åŠŸèƒ½ï¼ˆ3å‘¨ï¼‰
- [ ] å¤æ‚ä¿ƒé”€è§„åˆ™
- [ ] ä¼˜æƒ åˆ¸ç³»ç»Ÿé›†æˆ
- [ ] åº“å­˜éªŒè¯é€»è¾‘
- [ ] èµ å“å¤„ç†é€»è¾‘

### Phase 3ï¼šä¼˜åŒ–å¢å¼ºï¼ˆ2å‘¨ï¼‰
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] ç¼“å­˜ç­–ç•¥
- [ ] ç›‘æ§å‘Šè­¦
- [ ] å‹åŠ›æµ‹è¯•

### Phase 4ï¼šæ‰©å±•åŠŸèƒ½ï¼ˆ2å‘¨ï¼‰
- [ ] å¤šæ¸ é“æ”¯æŒ
- [ ] ç¬¬ä¸‰æ–¹é›†æˆ
- [ ] ç®¡ç†åå°
- [ ] æ•°æ®åˆ†æ

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

### 1. æŠ€æœ¯æŒ‡æ ‡
- ä»£ç è¦†ç›–ç‡ â‰¥ 90%
- PHPStan Level 8 é›¶é”™è¯¯
- API å“åº”æ—¶é—´è¾¾æ ‡ç‡ â‰¥ 95%

### 2. ä¸šåŠ¡æŒ‡æ ‡
- è´­ç‰©è½¦è½¬åŒ–ç‡æå‡ 5%
- ä»·æ ¼è®¡ç®—å‡†ç¡®ç‡ 100%
- ç”¨æˆ·æŠ•è¯‰ç‡ < 0.1%

---

*æœ¬ PRD å®šä¹‰äº†è®¢å•ç»“ç®—ç³»ç»Ÿçš„å®Œæ•´åŠŸèƒ½èŒƒå›´ï¼Œå¼ºè°ƒäº†é«˜åº¦è§£è€¦çš„æ¶æ„è®¾è®¡å’Œæ¥å£åŒ–çš„æ‰©å±•èƒ½åŠ›ï¼Œä¸ºç”µå•†å¹³å°æä¾›å¼ºå¤§è€Œçµæ´»çš„ç»“ç®—èƒ½åŠ›ã€‚*